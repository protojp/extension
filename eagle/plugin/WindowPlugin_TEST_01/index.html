<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <script type="text/javascript" src="js/plugin.js"></script>
    <style>
        body{
            color: #ccc;
        }
    </style>
</head>

<body>
	<div id="message"></div>
</body>

<script>
// const sharp = require('sharp');
const wmark = require('jimp-watermark');

const Jimp = require('jimp');
const fs = require('fs');

async function run(){
	console.log('script!!!!!');

	console.log(await eagle.library.info());

	let items = await eagle.item.get({
		rating: 4,
	});

	// let items = await eagle.item.getAll();
	console.log(items);
    console.log(items[0].filePath);

    let filePath = items[0].filePath;

    // Set your desired quality (0-100)
    let quality = 90;
    let scale = 0.3;// Set your desired scale (0-1)

    let WMlogo = 'D:/Eagle/SDwebUI.library/images/LUOAYVR16IO8T.info/proto_jp_80.png';
    let outputDir = 'D:/Download/';// Set your output directory here
    
    if (!fs.existsSync(outputDir))
        fs.mkdirSync(outputDir);// create the directory if it does not exist

    // Read the original image and the watermark image
    Promise.all([
        Jimp.read(filePath),
        Jimp.read(WMlogo)
    ])
    .then(images => {
        let originalImage = images[0];
        let watermark = images[1];

        let widthScaled = originalImage.bitmap.width * scale;
        let heightScaled = originalImage.bitmap.height * scale;

        // Resize the watermark according to the scaled dimensions
        watermark.resize(widthScaled, Jimp.AUTO);

        // Determine x and y coordinates for lower right position
        let xCoord = originalImage.bitmap.width - watermark.bitmap.width;
        let yCoord = originalImage.bitmap.height - watermark.bitmap.height;

        // Composite (overlay) the watermark on the original image at lower right position
        originalImage.composite(watermark, xCoord, yCoord, [
            { mode: Jimp.BLEND_SCREEN, opacitySource: 1, opacityDest: 1 }
        ]);

        return originalImage.quality(quality).write(`${outputDir}outputImage.jpg`);
    })
    .catch(err => {
        console.error(err);
    });
    

    
	console.log("終了！！");
};



setTimeout(run, 100);

</script>
</html>