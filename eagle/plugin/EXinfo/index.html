<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Inspector Plugin Example</title>
    <style>
        html {
            font-size: 11px;
            font-family: sans-serif;
            border-radius: 6px;
            overflow: hidden;
        }

        body {
            padding: 0;
            margin: 0;
            color: transparent;
            background: transparent;
        }

        /* colors for different themes */

        body[theme="LIGHT"],
        body[theme="LIGHTGRAY"] {
            color: black;
        }

        body[theme="GRAY"],
        body[theme="BLUE"],
        body[theme="PURPLE"],
        body[theme="DARK"] {
            color: white;
        }

        body[theme="LIGHT"] #wrapper,
        body[theme="LIGHTGRAY"] #wrapper {
            background: #ffffff;
            border: 1px solid #c9ced6;
        }

        body[theme="GRAY"] #wrapper,
        body[theme="BLUE"] #wrapper,
        body[theme="PURPLE"] #wrapper,
        body[theme="DARK"] #wrapper {
            background: #1e1f25;
            border: 1px solid #4a4f5a;
        }

        #wrapper {
            padding: 0;
            line-height: 1.6;
            border-radius: 0;
        }

        .row {
            display: flex;
            gap: 6px;
            margin-bottom: 6px;
            align-items: flex-start;
        }

        .label {
            color: #eee;
            padding-top: 4px;
        }

        .value {
            flex: 1;
            word-break: break-all;
            color: #eee;
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
            min-height: 18px;
        }

        .pill {
            display: inline-flex;
            align-items: center;
            padding: 2px 6px;
            border-radius: 4px;
            border: 1px solid #475569;
            color: inherit;
            background: #333;
        }

        .buttons {
            display: flex;
            gap: 8px;
            margin: 10px 0;
            align-items: center;
            width: 100%;
        }

        button {
            padding: 2px;
            border-radius: 6px;
            border: 1px solid #3b82f6;
            background: #3b82f6;
            color: #ffffff;
            cursor: pointer;
            flex: 0 0 auto;
        }

        body[theme="GRAY"] button,
        body[theme="BLUE"] button,
        body[theme="PURPLE"] button,
        body[theme="DARK"] button {
            border-color: #60a5fa;
            background: #60a5fa;
            color: #0b1220;
        }

        button:hover {
            opacity: 0.8;
        }

        select {
            padding: 6px 8px;
            border-radius: 6px;
            border: 1px solid #94a3b8;
            background: #ffffff;
            color: #0f172a;
            cursor: pointer;
            flex: 1 1 auto;
            min-width: 0;
        }

        body[theme="GRAY"] select,
        body[theme="BLUE"] select,
        body[theme="PURPLE"] select,
        body[theme="DARK"] select {
            background: #111827;
            color: #e5e7eb;
            border-color: #475569;
        }
    </style>
</head>

<body>
    <div id="wrapper">
        <div class="row">
            <span class="label">CP :</span>
            <span id="ckptName" class="value">-</span>
        </div>
        <div class="row">
            <span class="label">LoRA :</span>
            <span id="loraName" class="value">-</span>
        </div>
        <!-- <div class="buttons">
            <select id="selectSample">
                <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                <option value="option1">„Çµ„É≥„Éó„É´1</option>
                <option value="option2">„Çµ„É≥„Éó„É´2</option>
                <option value="option3">„Çµ„É≥„Éó„É´3</option>
            </select>
            <button id="btnA">üì§</button>
        </div> -->
    </div>
    <script>
        const loraEl = document.getElementById('loraName')
        const cpEl = document.getElementById('ckptName')

        const setTheme = async () => {
            const theme = await eagle.app.theme
            document.body.setAttribute('theme', theme)
        }

        const getSelectedItems = async () => {
            const items = await eagle.item.get({ isSelected: true, fields: ['tags'] })
            if (!items) return []
            return Array.isArray(items) ? items : [items]
        }

        const EXCLUDED_LORA_NAMES = ['Hyper-SDXL-8steps-lora']

        const extractLoraNames = (tags = []) => {
            const names = tags
                .map(tag => {
                    const match = tag.match(/<lora:([^:>]+)[^>]*>/i)
                    return match ? match[1] : null
                })
                .filter(name => name && !EXCLUDED_LORA_NAMES.includes(name))
            return [...new Set(names)]
        }

        const extractCheckpointNames = (tags = []) => {
            const names = tags
                .map(tag => {
                    const match = tag.match(/^Model:\s*(.+)$/i)
                    return match ? match[1].trim() : null
                })
                .filter(Boolean)
            return [...new Set(names)]
        }

        const renderValues = (el, values) => {
            el.innerHTML = ''
            if (!values.length) {
                el.textContent = '-'
                return
            }
            values.forEach(value => {
                const pill = document.createElement('span')
                pill.className = 'pill'
                pill.textContent = value
                el.appendChild(pill)
            })
        }

        let lastRenderKey = ''

        const updateInfo = async (force = false) => {
            const items = await getSelectedItems()
            const tags = items.flatMap(item => item?.tags || [])
            const loraNames = extractLoraNames(tags)
            const cpNames = extractCheckpointNames(tags)
            const currentKey = `${loraNames.join('|')}__${cpNames.join('|')}`
            if (!force && currentKey === lastRenderKey) {
                return currentKey
            }
            renderValues(loraEl, loraNames)
            renderValues(cpEl, cpNames)
            lastRenderKey = currentKey
            return currentKey
        }

        const init = async () => {
            await setTheme()
            await updateInfo(true)
            setTimeout(() => {
                updateInfo()
            }, 1000)
        }

        eagle.onPluginCreate(async () => {
            await init()
        })

        eagle.onThemeChanged(theme => {
            document.body.setAttribute('theme', theme)
        })

        document.getElementById('btnA').addEventListener('click', () => {
            alert('„Éú„Çø„É≥ clicked')
            console.log('„Éú„Çø„É≥ clicked')
        })

        document.getElementById('selectSample').addEventListener('change', e => {
            const value = e.target.value
            if (!value) return
            alert(`ÈÅ∏Êäû: ${value}`)
            console.log('selected option:', value)
        })
    </script>
</body>

</html>
