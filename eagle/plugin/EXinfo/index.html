<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>EXinfo X Post</title>
    <style>
        html {
            font-size: 11px;
            font-family: sans-serif;
            border-radius: 6px;
            overflow: hidden;
        }

        body {
            padding: 0;
            margin: 0;
            color: transparent;
            background: transparent;
        }

        body[theme="LIGHT"],
        body[theme="LIGHTGRAY"] {
            color: black;
        }

        body[theme="GRAY"],
        body[theme="BLUE"],
        body[theme="PURPLE"],
        body[theme="DARK"] {
            color: white;
        }

        body[theme="LIGHT"] #wrapper,
        body[theme="LIGHTGRAY"] #wrapper {
            background: #ffffff;
            border: 1px solid #c9ced6;
        }

        body[theme="GRAY"] #wrapper,
        body[theme="BLUE"] #wrapper,
        body[theme="PURPLE"] #wrapper,
        body[theme="DARK"] #wrapper {
            background: #1e1f25;
            border: 1px solid #4a4f5a;
        }

        #wrapper {
            padding: 0;
            line-height: 1.6;
            border-radius: 0;
        }

        .row {
            display: flex;
            gap: 6px;
            margin-bottom: 6px;
            align-items: flex-start;
        }

        .label {
            color: #eee;
            padding-top: 4px;
        }

        .value {
            flex: 1;
            word-break: break-all;
            color: #eee;
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
            min-height: 18px;
        }

        .pill {
            display: inline-flex;
            align-items: center;
            padding: 2px 6px;
            border-radius: 4px;
            border: 1px solid #475569;
            color: inherit;
            background: #333;
        }

        .control {
            display: flex;
            gap: 8px;
            margin: 10px 0;
            align-items: center;
            width: 100%;
        }

        .status {
            font-size: 10px;
            margin: 4px 0 0;
            color: #94a3b8;
        }

        .status[data-type="error"] {
            color: #ef4444;
        }

        .status[data-type="success"] {
            color: #22c55e;
        }

        .status[data-type="warn"] {
            color: #f59e0b;
        }

        button {
            padding: 2px;
            border-radius: 6px;
            border: 1px solid #3b82f6;
            background: #3b82f6;
            color: #ffffff;
            cursor: pointer;
            flex: 0 0 auto;
        }

        body[theme="GRAY"] button,
        body[theme="BLUE"] button,
        body[theme="PURPLE"] button,
        body[theme="DARK"] button {
            border-color: #60a5fa;
            background: #60a5fa;
            color: #0b1220;
        }

        button:hover {
            opacity: 0.8;
        }

        select {
            padding: 6px 8px;
            border-radius: 6px;
            border: 1px solid #94a3b8;
            background: #ffffff;
            color: #0f172a;
            cursor: pointer;
            flex: 1 1 auto;
            min-width: 0;
        }

        body[theme="GRAY"] select,
        body[theme="BLUE"] select,
        body[theme="PURPLE"] select,
        body[theme="DARK"] select {
            background: #111827;
            color: #e5e7eb;
            border-color: #475569;
        }
    </style>
</head>

<body>
    <div id="wrapper">
        <div class="row">
            <span class="label">CP :</span>
            <span id="ckptName" class="value">-</span>
        </div>
        <div class="row">
            <span class="label">LoRA :</span>
            <span id="loraName" class="value">-</span>
        </div>
        <div class="control">
            <select id="selectID">
                <option value="">ID„ÇíÈÅ∏Êäû</option>
            </select>
            <button id="postX" disabled>üì§</button>
        </div>
        <div class="status" id="statusLine">auth.json „ÇíË™≠„ÅøËæº„Åø‰∏≠...</div>
    </div>
    <script>
        const fs = require('fs')
        const path = require('path')
        const { execFile } = require('child_process')

        const ACCOUNTS_PATH = 'C:\\github\\protojp\\sns\\accounts\\x\\auth.json'
        const POST_SCRIPT = 'C:\\github\\protojp\\sns\\accounts\\x\\test-post.js'

        const accountSelect = document.getElementById('selectID')
        const postButton = document.getElementById('postX')
        const statusLine = document.getElementById('statusLine')
        const loraEl = document.getElementById('loraName')
        const cpEl = document.getElementById('ckptName')

        const state = {
            accounts: [],
            selectedId: '',
            posting: false
        }

        const setStatus = (message, type = 'info') => {
            statusLine.textContent = message
            statusLine.dataset.type = type
        }

        const setTheme = async () => {
            const theme = await eagle.app.theme
            document.body.setAttribute('theme', theme)
        }

        const getSelectedItems = async (extraFields = []) => {
            const fields = Array.from(new Set(['tags', ...extraFields]))
            const items = await eagle.item.get({ isSelected: true, fields })
            if (!items) return []
            return Array.isArray(items) ? items : [items]
        }

        const EXCLUDED_LORA_NAMES = ['Hyper-SDXL-8steps-lora']

        const extractLoraNames = (tags = []) => {
            const names = tags
                .map(tag => {
                    const match = tag.match(/<lora:([^:>]+)[^>]*>/i)
                    return match ? match[1] : null
                })
                .filter(name => name && !EXCLUDED_LORA_NAMES.includes(name))
            return [...new Set(names)]
        }

        const extractCheckpointNames = (tags = []) => {
            const names = tags
                .map(tag => {
                    const match = tag.match(/^Model:\s*(.+)$/i)
                    return match ? match[1].trim() : null
                })
                .filter(Boolean)
            return [...new Set(names)]
        }

        const renderValues = (el, values) => {
            el.innerHTML = ''
            if (!values.length) {
                el.textContent = '-'
                return
            }
            values.forEach(value => {
                const pill = document.createElement('span')
                pill.className = 'pill'
                pill.textContent = value
                el.appendChild(pill)
            })
        }

        let lastRenderKey = ''

        const updateInfo = async (force = false) => {
            const items = await getSelectedItems()
            const tags = items.flatMap(item => item?.tags || [])
            const loraNames = extractLoraNames(tags)
            const cpNames = extractCheckpointNames(tags)
            const currentKey = `${loraNames.join('|')}__${cpNames.join('|')}`
            if (!force && currentKey === lastRenderKey) {
                return currentKey
            }
            renderValues(loraEl, loraNames)
            renderValues(cpEl, cpNames)
            lastRenderKey = currentKey
            return currentKey
        }

        const validateAccount = account => {
            if (!account || !account.id || !account.auth) return false
            const { consumerKey, consumerSecret, accessToken, accessTokenSecret } = account.auth
            return Boolean(consumerKey && consumerSecret && accessToken && accessTokenSecret)
        }

        const loadAccounts = async () => {
            try {
                setStatus('auth.json „ÇíË™≠„ÅøËæº„Åø‰∏≠...')
                const raw = await fs.promises.readFile(ACCOUNTS_PATH, 'utf8')
                const parsed = JSON.parse(raw)
                if (!Array.isArray(parsed)) throw new Error('ÈÖçÂàóÂΩ¢Âºè„Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì')
                const validAccounts = parsed.filter(validateAccount)
                if (!validAccounts.length) throw new Error('ÊúâÂäπ„Å™„Ç¢„Ç´„Ç¶„É≥„Éà„Åå„ÅÇ„Çä„Åæ„Åõ„Çì')
                state.accounts = validAccounts
                accountSelect.innerHTML = ''
                const placeholder = document.createElement('option')
                placeholder.value = ''
                placeholder.textContent = 'ID„ÇíÈÅ∏Êäû'
                accountSelect.appendChild(placeholder)
                validAccounts.forEach(acc => {
                    const opt = document.createElement('option')
                    opt.value = acc.id
                    opt.textContent = acc.id
                    accountSelect.appendChild(opt)
                })
                const first = validAccounts[0]
                state.selectedId = first.id
                accountSelect.value = first.id
                postButton.disabled = false
                setStatus(`ÊäïÁ®øÂÖà: ${first.id}`)
            } catch (err) {
                postButton.disabled = true
                setStatus(`auth.json Ë™≠„ÅøËæº„ÅøÂ§±Êïó: ${err.message}`, 'error')
            }
        }

        const toLocalPath = value => {
            if (!value) return value
            if (value.startsWith('file://')) return decodeURIComponent(value.replace('file://', ''))
            return value
        }

        const getSingleSelectedItem = async () => {
            const items = await getSelectedItems(['id', 'name', 'ext', 'path', 'filePath', 'url', 'originPath', 'folderPath'])
            if (!items.length) throw new Error('ÁîªÂÉè„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì')
            const item = items[0]
            console.log('[EXinfo] selected item:', item)
            console.log('[EXinfo] item keys:', Object.keys(item || {}))

            const query = new URLSearchParams(location.search)
            const queryPathRaw = query.get('path')
            const queryPath = queryPathRaw ? decodeURIComponent(queryPathRaw) : ''
            if (queryPath) console.log('[EXinfo] query path:', queryPath)

            const resolvedPathRaw =
                item.path ||
                item.filePath ||
                item.originPath ||
                item.url ||
                queryPath

            const resolvedPath = toLocalPath(resolvedPathRaw)
            console.log('[EXinfo] resolved path:', resolvedPath)

            if (!resolvedPath) throw new Error('ÁîªÂÉè„Éë„Çπ/URL„ÇíÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü')
            return { ...item, path: resolvedPath }
        }

        const runPostScript = ({ imagePath, text }) =>
            new Promise((resolve, reject) => {
                const args = ['--image', imagePath, '--text', text]
                console.log('[EXinfo] execFile node', POST_SCRIPT, args)
                execFile('node', [POST_SCRIPT, ...args], { timeout: 120000 }, (error, stdout, stderr) => {
                    if (stdout) console.log('[EXinfo] post stdout:', stdout)
                    if (stderr) console.error('[EXinfo] post stderr:', stderr)
                    if (error) {
                        reject(error)
                    } else {
                        resolve(stdout)
                    }
                })
            })

        const init = async () => {
            await setTheme()
            await updateInfo(true)
            await loadAccounts()
            setTimeout(() => {
                updateInfo()
            }, 1000)
        }

        eagle.onPluginCreate(async () => {
            await init()
        })

        eagle.onThemeChanged(theme => {
            document.body.setAttribute('theme', theme)
        })

        accountSelect.addEventListener('change', e => {
            state.selectedId = e.target.value
            postButton.disabled = !state.selectedId || state.posting
            if (!state.selectedId) {
                setStatus('ÊäïÁ®øÂÖàID„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'warn')
            } else {
                setStatus(`ÊäïÁ®øÂÖà: ${state.selectedId}`)
            }
        })

        postButton.addEventListener('click', async () => {
            if (state.posting) return
            if (!state.selectedId) {
                setStatus('ÊäïÁ®øÂÖàID„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'warn')
                return
            }
            try {
                state.posting = true
                postButton.disabled = true
                setStatus('X „Å´ÊäïÁ®ø‰∏≠...')
                const item = await getSingleSelectedItem()
                const text = item.name || 'Shared from Eagle'
                await runPostScript({ imagePath: item.path, text })
                setStatus('ÊäïÁ®øÂÆå‰∫ÜÔºàCLIÁµåÁî±Ôºâ', 'success')
            } catch (err) {
                console.error('[EXinfo] post error:', err)
                setStatus(`ÊäïÁ®ø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${err.message}`, 'error')
            } finally {
                state.posting = false
                postButton.disabled = !state.selectedId
            }
        })
    </script>
</body>

</html>
